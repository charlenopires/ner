{% extends "base.html" %}
{% block content %}
    <main class="main">

      <!-- HERO -->
      <div class="hero">
        <h1>Reconhecimento de Entidades Nomeadas</h1>
        <p>
          Algoritmo NER implementado em <strong>Rust</strong> com <strong>CRF + algoritmo de Viterbi</strong>.
          Observe cada passo â€” tokenizaÃ§Ã£o, extraÃ§Ã£o de features, regras e decodificaÃ§Ã£o â€” em tempo real via WebSocket.
        </p>
      </div>

      <!-- LEFT COLUMN -->
      <div>

        <!-- Algorithm pipeline diagram -->
        <div class="card" style="margin-bottom:1rem;">
          <div class="card-header">
            <span class="card-title">ğŸ“Š Pipeline do Algoritmo</span>
          </div>
          <div class="algo-diagram" id="algo-diagram">
            <div class="algo-step" id="step-tok" title="Divide o texto em tokens"><span
                class="algo-emoji">âœ‚ï¸</span>TokenizaÃ§Ã£o</div>
            <span class="algo-arrow">â†’</span>
            <div class="algo-step" id="step-feat" title="CapitalizaÃ§Ã£o, prefixos, sufixos, contexto"><span
                class="algo-emoji">ğŸ”¬</span>Features</div>
            <span class="algo-arrow">â†’</span>
            <div class="algo-step" id="step-rule" title="Gazetteers e padrÃµes regex"><span
                class="algo-emoji">ğŸ“‹</span>Regras</div>
            <span class="algo-arrow">â†’</span>
            <div class="algo-step" id="step-crf" title="Scores de emissÃ£o CRF"><span class="algo-emoji">ğŸ“ˆ</span>CRF
              Score
            </div>
            <span class="algo-arrow">â†’</span>
            <div class="algo-step" id="step-vit" title="SequÃªncia Ã³tima de tags"><span
                class="algo-emoji">ğŸ¯</span>Viterbi
            </div>
            <span class="algo-arrow">â†’</span>
            <div class="algo-step" id="step-ent" title="Entidades identificadas"><span
                class="algo-emoji">âœ…</span>Entidades</div>
          </div>
        </div>

        <!-- Input + Result card -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">ğŸ“ Texto de Entrada</span>
          </div>
          <div class="card-body">
            <div class="input-area">
              <textarea id="text-input"
                placeholder="Digite ou cole um texto em portuguÃªs brasileiro. Ex: Santos Dumont realizou o primeiro voo em Paris. O Hospital Albert Einstein em SÃ£o Paulo..."
                rows="5"></textarea>
            </div>

            <!-- Tokenizer Mode Selector -->
            <div class="algo-mode-panel">
              <span class="algo-mode-label">ğŸ”  Tokenizador:</span>
              <div class="algo-mode-toggle" id="tokenizer-mode-toggle">
                <button class="mode-btn active" data-mode="standard" onclick="selectTokenizer(this)">
                  Standard
                </button>
                <button class="mode-btn" data-mode="aggressive" onclick="selectTokenizer(this)">
                  Aggressive
                </button>
                <button class="mode-btn" data-mode="conservative" onclick="selectTokenizer(this)">
                  Conservative
                </button>
                <button class="mode-btn" data-mode="bpe_lite" onclick="selectTokenizer(this)">
                  BPE Lite
                </button>
                <button class="mode-btn" data-mode="char_level" onclick="selectTokenizer(this)">
                  Char
                </button>
              </div>
            </div>

            <!-- Algorithm Mode Selector -->
            <div class="algo-mode-panel">
              <span class="algo-mode-label">âš™ï¸ Algoritmo:</span>
              <div class="algo-mode-toggle" id="algo-mode-toggle">
                <button class="mode-btn active" data-mode="hybrid" onclick="selectMode(this)">
                  <span class="mode-icon">âš¡</span> HÃ­brido
                </button>
                <button class="mode-btn" data-mode="hmm" onclick="selectMode(this)">
                  <span class="mode-icon">ğŸ²</span> HMM
                </button>
                <button class="mode-btn" data-mode="max_ent" onclick="selectMode(this)">
                  <span class="mode-icon">âš–ï¸</span> MaxEnt
                </button>
                <button class="mode-btn" data-mode="perceptron" onclick="selectMode(this)">
                  <span class="mode-icon">ğŸ§ </span> Percep
                </button>
                <button class="mode-btn" data-mode="span_based" onclick="selectMode(this)">
                  <span class="mode-icon">ğŸ“</span> Span
                </button>
                <button class="mode-btn" data-mode="rules_only" onclick="selectMode(this)">
                  <span class="mode-icon">ğŸ“‹</span> Regras
                </button>
                <button class="mode-btn" data-mode="crf_only" onclick="selectMode(this)">
                  <span class="mode-icon">ğŸ“ˆ</span> CRF
                </button>
              </div>
              <span class="mode-desc" id="mode-desc">Regras + CRF/Viterbi (melhor precisÃ£o)</span>
            </div>

            <div class="demo-texts" id="demo-texts">
              <span style="font-size:0.75rem; color:var(--text-muted); align-self:center;">Exemplos:</span>
            </div>

            <button class="btn-analyze" id="btn-analyze" onclick="startAnalysis()">
              <span id="btn-icon">ğŸ”</span>
              <span id="btn-label">Analisar Texto</span>
            </button>
          </div>

          <!-- Result display -->
          <div style="padding: 0 1.25rem 1.25rem;">
            <div class="card-title" style="margin-bottom:0.75rem; padding-top:0.5rem;">
              ğŸ·ï¸ Resultado
            </div>
            <div id="result-display">
              <p class="placeholder-text">O texto anotado aparecerÃ¡ aqui com entidades destacadas</p>
            </div>
            <div id="entity-chips"></div>
          </div>

          <!-- Legend -->
          <div class="legend">
            <div class="legend-item">
              <div class="legend-dot" style="background:var(--per-color)"></div>
              <span>ğŸ‘¤ Pessoa</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background:var(--org-color)"></div>
              <span>ğŸ¢ OrganizaÃ§Ã£o</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background:var(--loc-color)"></div>
              <span>ğŸ“ Local</span>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background:var(--misc-color)"></div>
              <span>ğŸ”– Misc</span>
            </div>
          </div>
        </div>

        <!-- Stats bar -->
        <div id="stats-bar" style="margin-top:1rem;">
          <div class="stat-cell">
            <div class="stat-value" id="stat-tokens">â€”</div>
            <div class="stat-label">Tokens</div>
          </div>
          <div class="stat-cell">
            <div class="stat-value" id="stat-entities">â€”</div>
            <div class="stat-label">Entidades</div>
          </div>
          <div class="stat-cell">
            <div class="stat-value" id="stat-ms">â€”</div>
            <div class="stat-label">ms</div>
          </div>
          <div class="stat-cell">
            <div class="stat-value" id="stat-steps">â€”</div>
            <div class="stat-label">Eventos</div>
          </div>
        </div>

      </div><!-- /left column -->

      <!-- RIGHT COLUMN (sidebar) -->
      <div class="sidebar">

        <!-- WS Status -->
        <div id="ws-status">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-text">Aguardando anÃ¡lise...</span>
        </div>

        <!-- Pipeline steps log -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">âš¡ Eventos do Pipeline</span>
            <button onclick="clearSteps()"
              style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:0.75rem;">Limpar</button>
          </div>
          <div id="pipeline-steps">
            <div class="step-item step-done">
              <span class="step-icon">ğŸ’¡</span>
              <div class="step-content">
                <div class="step-title">Como usar</div>
                <div class="step-detail">Digite um texto e clique em "Analisar" para ver cada passo do algoritmo NER em
                  tempo real.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Viterbi Table -->
        <div class="card" id="viterbi-section">
          <div class="card-header">
            <span class="card-title">ğŸ¯ Tabela Viterbi</span>
            <span style="font-size:0.72rem; color:var(--text-muted)">token â†’ melhor tag</span>
          </div>
          <div class="viterbi-table-wrap">
            <table class="viterbi-table" id="viterbi-table">
              <thead>
                <tr>
                  <th>Token</th>
                  <th>Melhor Tag</th>
                  <th>Score</th>
                  <th>Anterior</th>
                </tr>
              </thead>
              <tbody id="viterbi-tbody"></tbody>
            </table>
          </div>
        </div>

      </div><!-- /sidebar -->

    </main>

    <!-- ============================================================
       JAVASCRIPT
  ============================================================ -->
    <script>
      // ---------------------------------------------------------------
      // WebSocket Management
      // ---------------------------------------------------------------
      let ws = null;
      let stepCount = 0;
      let entityCount = 0;
      let tokenCount = 0;
      let viterbiRows = [];

      function getWsUrl() {
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        return `${proto}://${location.host}/ws`;
      }

      function connectWs() {
        ws = new WebSocket(getWsUrl());

        ws.onopen = () => {
          setStatus('connected', 'WebSocket conectado â€” pronto');
        };

        ws.onclose = () => {
          setStatus('', 'Reconectando...');
          setTimeout(connectWs, 2000);
        };

        ws.onerror = () => {
          setStatus('', 'Erro na conexÃ£o');
        };

        ws.onmessage = (evt) => {
          try {
            const event = JSON.parse(evt.data);
            handleEvent(event);
          } catch (e) {
            console.error('Evento invÃ¡lido:', e);
          }
        };
      }

      function setStatus(cls, text) {
        const dot = document.getElementById('status-dot');
        const txt = document.getElementById('status-text');
        dot.className = 'status-dot ' + cls;
        txt.textContent = text;
      }

      // ---------------------------------------------------------------
      // Event Handlers
      // ---------------------------------------------------------------
      function handleEvent(event) {
        stepCount++;
        document.getElementById('stat-steps').textContent = stepCount;

        switch (event.type) {
          case 'TokenizationDone':
            handleTokenization(event.data);
            break;
          case 'FeaturesComputed':
            handleFeatures(event.data);
            break;
          case 'RuleApplied':
            handleRule(event.data);
            break;
          case 'ViterbiStep':
            handleViterbi(event.data);
            break;
          case 'TagAssigned':
            handleTagAssigned(event.data);
            break;
          case 'Done':
            handleDone(event.data);
            break;
          case 'Error':
            addStep('âŒ', 'Erro', event.data.message, 'step-done');
            setStatus('', 'Erro durante anÃ¡lise');
            setBtnReady();
            break;
        }
      }

      function handleTokenization(data) {
        tokenCount = data.total;
        document.getElementById('stat-tokens').textContent = data.total;
        setAlgoStep('step-tok');

        addStep('âœ‚ï¸',
          `TokenizaÃ§Ã£o â€” ${data.total} tokens`,
          `Texto dividido em ${data.total} tokens: ${data.tokens.slice(0, 5).map(t => '"' + t.text + '"').join(', ')}${data.total > 5 ? '...' : ''}`,
          'step-tok'
        );
      }

      function handleFeatures(data) {
        setAlgoStep('step-feat');
        if (data.token_index % 3 === 0) { // Mostra a cada 3 tokens pra nÃ£o poluir
          const top3 = data.top_features.slice(0, 3).map(([k]) => k).join(', ');
          addStep('ğŸ”¬',
            `Features: "${data.token_text}"`,
            `${data.top_features.length} features â†’ Top: ${top3}`,
            'step-feat'
          );
        }
      }

      function handleRule(data) {
        setAlgoStep('step-rule');
        const catCls = tagToCls(data.tag);
        addStep('ğŸ“‹',
          `Regra: "${data.token_text}"`,
          `<span class="step-tag ent-${catCls}">${data.tag}</span> via ${data.rule_name} (${Math.round(data.confidence * 100)}% conf.)`,
          'step-rule'
        );
      }

      function handleViterbi(data) {
        setAlgoStep('step-crf');
        setAlgoStep('step-vit');
        const step = data.step;
        const best = step.best_tag;
        const catCls = tagToCls(best);

        addStep('ğŸ¯',
          `Viterbi tk[${step.token_index}]: "${data.token_text}"`,
          `Melhor: <span class="step-tag ent-${catCls}">${best}</span> (score ${step.best_score.toFixed(2)})`,
          'step-vit'
        );

        // Atualiza tabela Viterbi
        addViterbiRow(data.token_text, step.best_tag, step.best_score,
          step.scores.find(s => s.tag === step.best_tag)?.best_prev || 'â€”');
      }

      function handleTagAssigned(data) {
        // Silencioso â€” sÃ³ mostra entidades (nÃ£o-O)
        if (data.tag !== 'O' && data.tag.startsWith('B-')) {
          setAlgoStep('step-ent');
          const catCls = tagToCls(data.tag);
          addStep('ğŸ·ï¸',
            `Tag atribuÃ­da: "${data.token_text}"`,
            `<span class="step-tag ent-${catCls}">${data.tag}</span> fonte: ${data.source} (${Math.round(data.confidence * 100)}%)`,
            'step-tag-ev'
          );
        }
      }

      function handleDone(data) {
        entityCount = data.entities.length;
        document.getElementById('stat-entities').textContent = entityCount;
        document.getElementById('stat-ms').textContent = data.processing_ms;

        // Mark all algo steps as done
        ['step-tok', 'step-feat', 'step-rule', 'step-crf', 'step-vit', 'step-ent'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.className = 'algo-step done';
        });

        addStep('âœ…',
          `ConcluÃ­do â€” ${entityCount} entidades em ${data.processing_ms}ms`,
          `${data.total_tokens} tokens processados`,
          'step-done'
        );

        // Renderiza o texto anotado
        renderAnnotatedText(data);

        // Mostra stats e viterbi
        document.getElementById('stats-bar').classList.add('visible');
        if (viterbiRows.length > 0) {
          document.getElementById('viterbi-section').classList.add('visible');
        }

        setStatus('connected', `Pronto â€” ${entityCount} entidades encontradas`);
        setBtnReady();
      }

      // ---------------------------------------------------------------
      // Render annotated text
      // ---------------------------------------------------------------
      function renderAnnotatedText(data) {
        const tokens = data.tagged_tokens;
        const entities = data.entities;
        const display = document.getElementById('result-display');
        const chips = document.getElementById('entity-chips');

        if (tokens.length === 0) {
          display.innerHTML = '<p class="placeholder-text">Nenhum token encontrado</p>';
          return;
        }

        // Build entity map: token_start â†’ entity
        const entityMap = new Map();
        const entityEndMap = new Set();
        for (const ent of entities) {
          entityMap.set(ent.start_token, ent);
          for (let i = ent.start_token; i <= ent.end_token; i++) {
            entityEndMap.add(i);
          }
        }

        let html = '';
        const processedTokens = new Set();

        for (let i = 0; i < tokens.length; i++) {
          const tt = tokens[i];
          if (processedTokens.has(i)) continue;

          if (entityMap.has(i)) {
            const ent = entityMap.get(i);
            const cls = catToCls(ent.category);
            const icon = catToIcon(ent.category);

            // Collect all tokens of this entity
            let entText = '';
            for (let j = ent.start_token; j <= ent.end_token && j < tokens.length; j++) {
              if (j > ent.start_token) {
                const prev = tokens[j - 1];
                const curr = tokens[j];
                if (curr.start > prev.end) entText += ' ';
              }
              entText += tokens[j].token.text;
              processedTokens.add(j);
            }

            const conf = Math.round(ent.confidence * 100);
            html += `<span class="ent ent-${cls}" title="${ent.category} â€” ${conf}% confianÃ§a\nFonte: ${ent.source}">${entText}<span class="ent-label">${icon}${ent.category}</span></span> `;
          } else {
            html += escapeHtml(tt.token.text) + ' ';
          }
        }

        display.innerHTML = html;

        // Chips de entidades
        chips.innerHTML = '';
        const countsByCat = {};
        for (const ent of entities) {
          countsByCat[ent.category] = (countsByCat[ent.category] || 0) + 1;
        }

        // Unique entities (group by text+category)
        const seen = new Set();
        for (const ent of entities) {
          const key = `${ent.text}|${ent.category}`;
          if (seen.has(key)) continue;
          seen.add(key);

          const cls = catToCls(ent.category);
          const icon = catToIcon(ent.category);
          const chip = document.createElement('div');
          chip.className = `entity-chip ent-${cls}`;
          chip.title = `ConfianÃ§a: ${Math.round(ent.confidence * 100)}% | Fonte: ${ent.source}`;
          chip.innerHTML = `${icon} <strong>${ent.text}</strong> <span style="opacity:0.7;font-size:0.7rem">${ent.category}</span>`;
          chips.appendChild(chip);
        }

        if (entities.length === 0) {
          chips.innerHTML = '<span style="color:var(--text-muted);font-size:0.82rem">Nenhuma entidade identificada</span>';
        }
      }

      // ---------------------------------------------------------------
      // Viterbi table
      // ---------------------------------------------------------------
      function addViterbiRow(token, bestTag, score, prevTag) {
        viterbiRows.push({ token, bestTag, score, prevTag });
        const tbody = document.getElementById('viterbi-tbody');
        const cls = tagToCls(bestTag);
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td style="color:var(--text-primary);font-weight:500">${escapeHtml(token)}</td>
        <td class="${bestTag !== 'O' ? 'viterbi-best' : ''}">
          <span class="step-tag ent-${cls}">${bestTag}</span>
        </td>
        <td style="font-family:'JetBrains Mono',monospace">${score.toFixed(2)}</td>
        <td style="color:var(--text-muted)">${prevTag}</td>
      `;
        tbody.appendChild(tr);
        // Auto-scroll
        const wrap = tbody.closest('.viterbi-table-wrap');
        if (wrap) wrap.scrollTop = wrap.scrollHeight;
      }

      // ---------------------------------------------------------------
      // Pipeline Steps Log
      // ---------------------------------------------------------------
      function addStep(icon, title, detail, cls) {
        const container = document.getElementById('pipeline-steps');
        const div = document.createElement('div');
        div.className = `step-item ${cls}`;
        div.innerHTML = `
        <span class="step-icon">${icon}</span>
        <div class="step-content">
          <div class="step-title">${title}</div>
          <div class="step-detail">${detail}</div>
        </div>
      `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
      }

      function clearSteps() {
        document.getElementById('pipeline-steps').innerHTML = '';
        stepCount = 0;
        document.getElementById('stat-steps').textContent = 'â€”';
      }

      // ---------------------------------------------------------------
      // Algorithm step highlight
      // ---------------------------------------------------------------
      let currentAlgoStep = null;
      function setAlgoStep(id) {
        if (currentAlgoStep === id) return;
        const all = ['step-tok', 'step-feat', 'step-rule', 'step-crf', 'step-vit', 'step-ent'];
        all.forEach(sid => {
          const el = document.getElementById(sid);
          if (!el) return;
          if (sid === id) el.className = 'algo-step active';
          else if (!el.classList.contains('done')) el.className = 'algo-step';
        });
        currentAlgoStep = id;
      }

      // ---------------------------------------------------------------
      // Start Analysis
      // ---------------------------------------------------------------
      function startAnalysis() {
        const text = document.getElementById('text-input').value.trim();
        if (!text) {
          document.getElementById('text-input').focus();
          return;
        }

        if (!ws || ws.readyState !== WebSocket.OPEN) {
          setStatus('', 'WebSocket desconectado, reconectando...');
          connectWs();
          setTimeout(() => startAnalysis(), 800);
          return;
        }

        // Reset state
        stepCount = 0;
        entityCount = 0;
        tokenCount = 0;
        viterbiRows = [];
        document.getElementById('viterbi-tbody').innerHTML = '';
        document.getElementById('viterbi-section').classList.remove('visible');
        document.getElementById('stats-bar').classList.remove('visible');
        document.getElementById('result-display').innerHTML = '<p class="placeholder-text">Processando...</p>';
        document.getElementById('entity-chips').innerHTML = '';
        clearSteps();

        // Reset algo steps
        ['step-tok', 'step-feat', 'step-rule', 'step-crf', 'step-vit', 'step-ent'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.className = 'algo-step';
        });

        // Update button
        const btn = document.getElementById('btn-analyze');
        const btnLabel = document.getElementById('btn-label');
        const btnIcon = document.getElementById('btn-icon');
        btn.disabled = true;
        btnIcon.innerHTML = '<span class="spinner"></span>';
        btnLabel.textContent = 'Analisando...';

        setStatus('processing', 'Pipeline em execuÃ§Ã£o...');

        // Send to WebSocket â€” now as JSON with mode
        const modeBtn = document.querySelector('#algo-mode-toggle .mode-btn.active');
        const mode = modeBtn ? modeBtn.dataset.mode : 'hybrid';

        const tokBtn = document.querySelector('#tokenizer-mode-toggle .mode-btn.active');
        const tokenizer_mode = tokBtn ? tokBtn.dataset.mode : 'standard';

        ws.send(JSON.stringify({ text, mode, tokenizer_mode }));
      }

      function setBtnReady() {
        const btn = document.getElementById('btn-analyze');
        const btnLabel = document.getElementById('btn-label');
        const btnIcon = document.getElementById('btn-icon');
        btn.disabled = false;
        btnIcon.textContent = 'ğŸ”';
        btnLabel.textContent = 'Analisar Texto';
      }

      const MODE_DESCRIPTIONS = {
        hybrid: 'Regras + CRF/Viterbi (melhor precisÃ£o)',
        rules_only: 'Apenas motor de regras e gazetteers',
        crf_only: 'Apenas CRF + Viterbi (sem regras)',
        features_only: 'Apenas tokenizaÃ§Ã£o + features (sem classificaÃ§Ã£o)',
        hmm: 'Hidden Markov Model (ProbabilÃ­stico)',
        max_ent: 'Maximum Entropy (Logistic Regression)',
        perceptron: 'Averaged Perceptron (Discriminativo Online)',
        span_based: 'Span-based NER (DetecÃ§Ã£o de trechos)',
      };

      function selectMode(btn) {
        document.querySelectorAll('#algo-mode-toggle .mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const descEl = document.getElementById('mode-desc');
        if (descEl) descEl.textContent = MODE_DESCRIPTIONS[btn.dataset.mode] || '';
      }

      function selectTokenizer(btn) {
        document.querySelectorAll('#tokenizer-mode-toggle .mode-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      }

      // ---------------------------------------------------------------
      // Demo Texts
      // ---------------------------------------------------------------
      async function loadDemoTexts() {
        try {
          const resp = await fetch('/demo-texts');
          const texts = await resp.json();
          const container = document.getElementById('demo-texts');
          for (const item of texts) {
            const btn = document.createElement('button');
            btn.className = 'demo-btn';
            btn.textContent = item.domain;
            btn.onclick = () => {
              document.getElementById('text-input').value = item.text;
            };
            container.appendChild(btn);
          }
        } catch (e) {
          console.warn('NÃ£o foi possÃ­vel carregar textos demo:', e);
        }
      }

      // ---------------------------------------------------------------
      // Utilities
      // ---------------------------------------------------------------
      function tagToCls(tag) {
        if (!tag || tag === 'O') return 'out';
        if (tag.includes('PER')) return 'per';
        if (tag.includes('ORG')) return 'org';
        if (tag.includes('LOC')) return 'loc';
        if (tag.includes('MISC')) return 'misc';
        return 'out';
      }

      function catToCls(cat) {
        switch (cat) {
          case 'Per': return 'per';
          case 'Org': return 'org';
          case 'Loc': return 'loc';
          case 'Misc': return 'misc';
          default: return 'out';
        }
      }

      function catToIcon(cat) {
        switch (cat) {
          case 'Per': return 'ğŸ‘¤ ';
          case 'Org': return 'ğŸ¢ ';
          case 'Loc': return 'ğŸ“ ';
          case 'Misc': return 'ğŸ”– ';
          default: return '';
        }
      }

      function escapeHtml(s) {
        return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      // Allow Ctrl+Enter to analyze
      document.addEventListener('DOMContentLoaded', () => {
        connectWs();
        loadDemoTexts();

        document.getElementById('text-input').addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            startAnalysis();
          }
        });
      });
    </script>
{% endblock %}
