{% extends "base.html" %}
{% block content %}
<main class="main" style="grid-template-columns: 1fr;">

    <!-- HERO -->
    <div class="hero">
        <h1
            style="background: linear-gradient(135deg, #e8e8f0 0%, #3b82f6 40%, #9333ea 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
            Simulador GLiNER ‚Äî SOTA 2024/2025
        </h1>
        <p>
            Modelos tradicionais de NER precisam de treino r√≠gido com r√≥tulos fixos. Os modelos <strong>SOTA
                (State-of-the-Art)</strong>
            como o <strong>GLiNER</strong> s√£o <em>Zero-Shot Generalists</em> ‚Äî recebem as categorias via "prompt" e
            usam <strong>Dot Product</strong> de similaridade entre Spans de texto e vetores sem√¢nticos das classes.
        </p>
    </div>

    <!-- Architecture diagram -->
    <div class="card" style="margin-bottom: 1rem;">
        <div class="card-header">
            <span class="card-title">üß¨ Arquitetura Span-Based NER</span>
            <span class="badge badge-crf"
                style="background: rgba(147, 51, 234, 0.15); color: #a78bfa; border-color: rgba(147, 51, 234, 0.3);">Zero-Shot</span>
        </div>
        <div class="algo-diagram">
            <div class="algo-step done"><span class="algo-emoji">üìÑ</span>Texto</div>
            <span class="algo-arrow">‚Üí</span>
            <div class="algo-step done"><span class="algo-emoji">‚úÇÔ∏è</span>Tokeniza√ß√£o</div>
            <span class="algo-arrow">‚Üí</span>
            <div class="algo-step active" id="step-span-enum"
                style="border-color: #9333ea; color: #a78bfa; background: rgba(147, 51, 234, 0.08); box-shadow: 0 0 12px rgba(147, 51, 234, 0.2);">
                <span class="algo-emoji">üìè</span>Span Enum
            </div>
            <span class="algo-arrow">‚Üí</span>
            <div class="algo-step active" id="step-dot"
                style="border-color: #3b82f6; color: #60a5fa; background: rgba(59, 130, 246, 0.08); box-shadow: 0 0 12px rgba(59, 130, 246, 0.2);">
                <span class="algo-emoji">üßÆ</span>Dot Product
            </div>
            <span class="algo-arrow">‚Üí</span>
            <div class="algo-step"><span class="algo-emoji">üéØ</span>Threshold</div>
            <span class="algo-arrow">‚Üí</span>
            <div class="algo-step"><span class="algo-emoji">‚úÖ</span>Predi√ß√µes</div>
        </div>
    </div>

    <!-- INTERACTIVE SPAN ENUMERATION VISUALIZER -->
    <div class="card" style="margin-bottom: 1rem;">
        <div class="card-header">
            <span class="card-title">üìè Como o Modelo Trabalha o Texto ‚Äî Enumera√ß√£o de Spans</span>
            <span class="badge badge-ws" style="font-size: 0.65rem;">Interativo</span>
        </div>
        <div class="card-body">
            <p style="font-size: 0.84rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 1rem;">
                Ao contr√°rio do NER Tradicional (token-a-token), o GLiNER enumera <strong>todos os spans
                    candidatos</strong>
                e compara cada um com o vetor sem√¢ntico de cada classe. Ajuste o comprimento m√°ximo e veja a explos√£o
                combinat√≥ria:
            </p>

            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                <label style="font-size: 0.8rem; color: var(--text-muted); white-space: nowrap;">Max Span:</label>
                <input type="range" id="sota-max-span" min="1" max="5" value="3" style="flex: 1;"
                    oninput="document.getElementById('sota-span-val').textContent = this.value; renderSpans();">
                <span id="sota-span-val"
                    style="font-family: var(--font-mono); color: var(--accent-blue); font-weight: 700; font-size: 1.1rem; min-width: 1.2em;">3</span>
            </div>

            <!-- Example sentence for span visualization -->
            <div
                style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.4rem;">
                Frase de Exemplo:
            </div>
            <div
                style="font-family: var(--font-mono); font-size: 0.9rem; padding: 0.75rem 1rem; background: var(--bg-card-3); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 1rem; color: var(--text-primary);">
                "Santos Dumont voou sobre Paris"
            </div>

            <div id="sota-span-grid"
                style="display: flex; flex-wrap: wrap; gap: 0.4rem; min-height: 48px; padding: 0.75rem; background: var(--bg-card-3); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 0.75rem;">
            </div>

            <div id="sota-span-stats" style="font-size: 0.8rem; color: var(--text-muted); text-align: right;"></div>

            <!-- Dot Product explanation -->
            <div
                style="margin-top: 1rem; padding: 0.85rem 1rem; background: rgba(59, 130, 246, 0.04); border: 1px solid rgba(59, 130, 246, 0.15); border-radius: var(--radius-sm); font-size: 0.82rem; color: var(--text-secondary); line-height: 1.6;">
                üßÆ <strong style="color: var(--accent-blue);">Dot Product:</strong>
                Para cada span, o modelo computa
                <code
                    style="background:rgba(0,0,0,0.3);padding:1px 5px;border-radius:3px;">œÉ(span_vec ¬∑ class_vec)</code>.
                Se ‚â• 0.5 ‚Üí entidade detectada. Todos os spans s√£o processados <strong>em paralelo</strong> ‚Äî
                sem a sequencialidade do BIO tradicional.
            </div>
        </div>
    </div>

    <!-- Concept cards: Tradicional vs SOTA -->
    <div class="card" style="margin-bottom: 1rem;">
        <div class="card-header">
            <span class="card-title">üí° Tradicional vs. SOTA</span>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div
                    style="padding: 1rem; background: var(--bg-card-3); border-radius: var(--radius-sm); border: 1px solid rgba(245, 158, 11, 0.2);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;">üèõÔ∏è</span>
                        <strong style="color: var(--loc-color); font-size: 0.9rem;">Tradicional (CRF/HMM)</strong>
                    </div>
                    <ul
                        style="font-size: 0.82rem; color: var(--text-secondary); padding-left: 1.2rem; line-height: 1.8;">
                        <li>Tags fixas: PER, LOC, ORG, MISC</li>
                        <li>Requer re-treinar para novas classes</li>
                        <li>Classifica√ß√£o Token ‚Ü¶ Tag (BIO)</li>
                        <li>Sequencial (cada token ‚Üí pr√≥ximo)</li>
                    </ul>
                </div>
                <div
                    style="padding: 1rem; background: var(--bg-card-3); border-radius: var(--radius-sm); border: 1px solid rgba(147, 51, 234, 0.2);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.2rem;">üöÄ</span>
                        <strong style="color: #a78bfa; font-size: 0.9rem;">SOTA (GLiNER / Span-Based)</strong>
                    </div>
                    <ul
                        style="font-size: 0.82rem; color: var(--text-secondary); padding-left: 1.2rem; line-height: 1.8;">
                        <li>Classes din√¢micas via prompt</li>
                        <li>Zero-Shot ‚Äî sem re-treinamento</li>
                        <li>Classifica√ß√£o Span ‚Ü¶ Classe (Dot Product)</li>
                        <li>Paralelo (spans independentes)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Input card -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">üìù Texto + Classes Zero-Shot</span>
        </div>
        <div class="card-body">
            <form hx-post="/htmx/sota" hx-target="#sota-results" hx-indicator="#sota-indicator"
                style="display: flex; flex-direction: column; gap: 1rem;">

                <!-- Zero-Shot Class input -->
                <div class="algo-mode-panel" style="flex-direction: column; align-items: stretch;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="algo-mode-label">üéØ Classes Zero-Shot:</span>
                        <span style="font-size: 0.72rem; color: var(--text-muted);">(separadas por v√≠rgula)</span>
                    </div>
                    <input type="text" name="classes" id="sota-classes" value="Pessoa, Local, Organizacao, Data"
                        placeholder="ex: Pessoa, Local, Gato, Pokemon..."
                        style="width: 100%; border: 1px solid var(--border-bright); background: var(--bg-card-3); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: var(--radius-sm); font-family: 'Inter', sans-serif; font-size: 0.95rem; margin-top: 0.5rem; outline: none; transition: border-color 0.2s;">
                    <div style="display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.5rem;">
                        <button type="button" class="demo-btn"
                            onclick="setSotaClasses('Pessoa, Local, Organizacao')">üè∑Ô∏è Cl√°ssico</button>
                        <button type="button" class="demo-btn" onclick="setSotaClasses('Pessoa, Data')">üìÖ Pessoa +
                            Data</button>
                        <button type="button" class="demo-btn" onclick="setSotaClasses('Organizacao, Local')">üè¢ Org +
                            Local</button>
                        <button type="button" class="demo-btn"
                            onclick="setSotaClasses('Pessoa, Local, Organizacao, Data')">üåê Completo</button>
                        <button type="button" class="demo-btn"
                            onclick="setSotaClasses('Doen√ßa, Medicamento, Hospital')">üíä Sa√∫de</button>
                    </div>
                </div>

                <div class="input-area">
                    <textarea id="sota-text-input" name="text" rows="5"
                        placeholder="Texto livre...">Em mar√ßo de 2024, Luiz In√°cio Lula da Silva representou o Brasil em uma reuni√£o no STF contra os grandes bancos, incluindo analistas da Apple Inc.</textarea>
                </div>

                <!-- Demo texts -->
                <div class="demo-texts">
                    <span style="font-size:0.75rem; color:var(--text-muted); align-self:center;">Exemplos:</span>
                    <button type="button" class="demo-btn"
                        onclick="setSotaDemo('Santos Dumont voou sobre Paris em outubro de 1901. O 14-Bis decolou do Campo de Bagatelle.')">Hist√≥rico</button>
                    <button type="button" class="demo-btn"
                        onclick="setSotaDemo('A Petrobras e o BNDES investiram R$2 bilh√µes em S√£o Paulo durante janeiro de 2025.')">Econ√¥mico</button>
                    <button type="button" class="demo-btn"
                        onclick="setSotaDemo('Neymar Jr. assinou contrato com o Al-Hilal na Ar√°bia Saudita em agosto de 2023.')">Esportivo</button>
                    <button type="button" class="demo-btn"
                        onclick="setSotaDemo('O Minist√©rio da Sa√∫de aprovou a vacina CoronaVac produzida pelo Instituto Butantan em S√£o Paulo.')">Sa√∫de</button>
                </div>

                <button type="submit" class="btn-analyze"
                    style="background: linear-gradient(135deg, #3b82f6, #9333ea);">
                    <span>üöÄ</span>
                    <span>Executar SOTA M√°gico</span>
                </button>
            </form>

            <!-- Result display -->
            <div style="margin-top: 1.5rem; position: relative;">
                <div class="card-title" style="margin-bottom:0.75rem;">
                    üßÆ An√°lise Vetorial Bidirecional (Span-to-Class)
                </div>
                <div id="sota-indicator" class="htmx-indicator" style="position: absolute; top: 0; right: 0;">
                    <div class="spinner" style="border-top-color: #9333ea;"></div>
                </div>
                <div id="sota-results"
                    style="background: var(--bg-card-3); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 1.25rem; min-height: 100px;">
                    <p class="placeholder-text">Clique em "Executar" para assistir a m√°gica Span-Based acontecendo.</p>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot" style="background: linear-gradient(135deg, #3b82f6, #9333ea);"></div>
                <span>üßÆ Dot Product Score</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background:var(--accent-green)"></div>
                <span>‚úÖ Acima do Threshold</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background:var(--text-muted)"></div>
                <span>‚ùå Abaixo do Threshold</span>
            </div>
        </div>
    </div>

</main>

<style>
    .htmx-indicator {
        display: none;
    }

    .htmx-request .htmx-indicator,
    .htmx-request.htmx-indicator {
        display: block;
    }

    #sota-classes:focus {
        border-color: #9333ea;
        box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }
</style>

<script>
    // Span enumeration visualizer
    const SOTA_TOKENS = ["Santos", "Dumont", "voou", "sobre", "Paris"];
    const SPAN_COLORS = [
        ['rgba(59,130,246,0.12)', 'rgba(59,130,246,0.35)', '#60a5fa'],
        ['rgba(147,51,234,0.12)', 'rgba(147,51,234,0.35)', '#a78bfa'],
        ['rgba(34,211,238,0.12)', 'rgba(34,211,238,0.35)', '#22d3ee'],
        ['rgba(52,211,153,0.12)', 'rgba(52,211,153,0.35)', '#34d399'],
        ['rgba(245,158,11,0.12)', 'rgba(245,158,11,0.35)', '#fbbf24'],
    ];

    function renderSpans() {
        const maxLen = parseInt(document.getElementById('sota-max-span').value);
        const grid = document.getElementById('sota-span-grid');
        const stats = document.getElementById('sota-span-stats');
        let html = '';
        let count = 0;
        for (let len = 1; len <= Math.min(maxLen, SOTA_TOKENS.length); len++) {
            const [bg, border, color] = SPAN_COLORS[(len - 1) % SPAN_COLORS.length];
            for (let start = 0; start <= SOTA_TOKENS.length - len; start++) {
                const span = SOTA_TOKENS.slice(start, start + len).join(' ');
                html += `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:14px;font-size:0.78rem;font-weight:500;background:${bg};border:1px solid ${border};color:${color};cursor:default;" title="comprimento ${len}">
                    <span style="font-size:0.6rem;opacity:0.6;">L${len}</span>${span}
                </span>`;
                count++;
            }
        }
        grid.innerHTML = html || '<span style="color:var(--text-muted);font-size:0.82rem;">Sem spans.</span>';
        stats.textContent = `${count} spans √ó classes = ${count} compara√ß√µes de Dot Product`;
    }

    function setSotaClasses(classes) {
        document.getElementById('sota-classes').value = classes;
    }
    function setSotaDemo(text) {
        document.getElementById('sota-text-input').value = text;
    }

    document.addEventListener('DOMContentLoaded', renderSpans);
</script>
{% endblock %}